<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Factorial GmbH, Hamburg">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Structure of the configuration file - Phabalicious</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/version-select.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Structure of the configuration file";
    var mkdocs_page_input_path = "configuration.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Phabalicious</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">How does phabalicious work in two sentences</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../installation/">Installation of needed dependencies</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../usage/">Running phabalicious</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../available-tasks/">Available tasks</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Structure of the configuration file</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#structure-of-the-configuration-file">Structure of the configuration file</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#overview">Overview</a></li>
        
            <li><a class="toctree-l3" href="#inheritance">Inheritance</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docker-integration/">Docker integration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../local-overrides/">Local overrides</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../scripts/">Scripts</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../app-scaffold/">Scaffolding a new app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../contribute/">Contributing to Phabalicious</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Changelog/">Changelog</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Phabalicious</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Structure of the configuration file</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/factorial-io/phabalicious/edit/develop/docs/docs/configuration.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="structure-of-the-configuration-file">Structure of the configuration file</h1>
<h2 id="overview">Overview</h2>
<p>The configuration is fetched from the file <code>fabfile.yaml</code> and should have the following structure:</p>
<pre><code class="yaml">name: &lt;the project name&gt;

needs:
  - list of methods

requires: 2.0

dockerHosts:
  docker1:
    ...

hosts:
  host1:
    ...
</code></pre>

<p>Here's the documentation of the supported and used keys:</p>
<h3 id="name">name</h3>
<p>The name of the project, it's only used for output.</p>
<h3 id="needs">needs</h3>
<p>List here all needed methods for that type of project. Available methods are:</p>
<ul>
<li><code>local</code> runs all commands for that configuration locally.</li>
<li><code>git</code> for deployments via git</li>
<li><code>ssh</code></li>
<li><code>drush</code> for support of drupal installations</li>
<li><code>files</code></li>
<li><code>Mattermost</code> for slack-notifications</li>
<li><code>docker</code> for docker-support</li>
<li><code>composer</code> for composer support</li>
<li><code>drupalconsole</code> for drupal-concole support</li>
</ul>
<p><strong>Example for drupal 7</strong></p>
<pre><code class="yaml">needs:
  - ssh
  - git
  - drush
  - files
</code></pre>

<p><strong>Example for drupal 8 composer based and dockerized</strong></p>
<pre><code class="yaml">needs:
  - ssh
  - git
  - drush
  - composer
  - docker
  - files
</code></pre>

<h3 id="requires">requires</h3>
<p>The file-format of phabalicious changed over time. Set this to the lowest version of phabalicious which can handle the file. Should bei <code>2.0</code></p>
<h3 id="hosts">hosts</h3>
<p>Hosts is a list of host-definitions which contain all needed data to connect to a remote host. Here's an example</p>
<pre><code class="yaml">hosts:
  exampleHost:
    host: example.host.tld
    user: example_user
    port: 2233
    type: dev
    rootFolder: /var/www/public
    gitRootFolder: /var/www
    siteFolder: /sites/default
    filesFolder: /sites/default/files
    backupFolder: /var/www/backups
    supportsInstalls: true|false
    supportsCopyFrom: true|false
    type: dev
    branch: develop
    docker:
      ...
    database:
      ...
    scripts:
      ...
    sshTunnel:
      ..

</code></pre>

<p>You can get all host-information including the default values using the phabalicious command <code>about</code>:</p>
<pre><code class="shell">phab --config=staging about
</code></pre>

<p>This will print all host configuration for the host <code>staging</code>.</p>
<h4 id="general-keys">General keys</h4>
<ul>
<li><code>type</code> defines the type of installation. Currently there are four types available:<ul>
<li><code>dev</code> for dev-installations, they won't backup the databases on deployment</li>
<li><code>test</code> for test-installations, similar than <code>dev</code>, no backups on deployments</li>
<li><code>stage</code> for staging-installations.</li>
<li><code>prod</code> for live-installations. Some tasks can not be run on live-installations as <code>install</code> or as a target for <code>copyFrom</code>
The main use-case is to run different scripts per type, see the <code>common</code>-section.</li>
</ul>
</li>
<li><code>rootFolder</code>  the web-root-folder of the installation, typically exposed to the public.</li>
<li><code>needs</code> a list of needed methods, if not set, the globally set <code>needs</code> gets used.</li>
<li><code>configName</code> is set by phabalicious, it's the name of the configuration</li>
<li><code>supportsInstalls</code>, default is true for <code>types</code> != <code>prod</code>. If sent to true you can run the <code>install</code>-task</li>
<li><code>supportsCopyFrom</code>, default is true. If set to true, you can use that configuration as a source for the <code>copy-from</code>-task.</li>
<li><code>backupBeforeDeploy</code> is set to true for <code>types</code> <code>stage</code> and <code>prod</code>, if set to true, a backup of the DB is made before a deployment.</li>
<li><code>tmpFolder</code>, default is <code>/tmp</code>.</li>
<li><code>shellProvider</code> defines how to run a shell, where commands are executed, current values are<ul>
<li><code>local</code>: all commands are run locally</li>
<li><code>ssh</code>: all commands are run via a ssh-shell</li>
<li><code>docker-exec</code> all commands are run via docker-exec.</li>
</ul>
</li>
</ul>
<h4 id="configuration-for-the-local-method">Configuration for the local-method</h4>
<ul>
<li><code>shellProvider</code> default is <code>local</code>, see above.</li>
<li><code>shellExecutable</code> default is <code>/bin/bash</code> The executable for running a shell. Please note, that phabalicious requires a sh-compatible shell.</li>
<li><code>shellProviderExecutable</code>, the command, which will create the process for a shell, here <code>/bin/bash</code></li>
</ul>
<h4 id="configuration-for-the-ssh-method">Configuration for the ssh-method</h4>
<ul>
<li><code>host</code>, <code>user</code>, <code>port</code> are used to connect via SSH to the remote machine. Please make sure SSH key forwarding is enabled on your installation. </li>
<li><code>disableKnownHosts</code>, default is false, set to true to ignore the known_hosts-file.</li>
<li><code>sshTunnel</code> phabalicious supports SSH-Tunnels, that means it can log in into another machine and forward the access to the real host. This is handy for dockerized installations, where the ssh-port of the docker-instance is not public. <code>sshTunnel</code> needs the following informations<ul>
<li><code>bridgeHost</code>: the host acting as a bridge.</li>
<li><code>bridgeUser</code>: the ssh-user on the bridge-host</li>
<li><code>bridgePort</code>: the port to connect to on the bridge-host</li>
<li><code>localPort</code>: the local port which gets forwarded to the <code>destPort</code>. If <code>localPort</code> is omitted, the ssh-port of the host-configuration is used. If the host-configuration does not have a port-property a random port is used.</li>
<li><code>destHost</code>: the destination host to forward to</li>
<li><code>destHostFromDockerContainer</code>: if set, the docker's Ip address is used for destHost. This is automatically set when using a <code>docker</code>-configuration, see there.</li>
<li><code>destPort</code>: the destination port to forward to</li>
</ul>
</li>
<li><code>shellProviderExecutable</code>, default is <code>/usr/bin/ssh</code>, the executable to establish the connection.</li>
</ul>
<h4 id="configuration-for-the-git-method">Configuration for the git-method</h4>
<ul>
<li><code>gitRootFolder</code>  the folder, where the git-repository lies. Defaults to <code>rootFolder</code></li>
<li><code>branch</code> the name of the branch to use for deployments, they get usually checked out and pulled from origin. </li>
<li><code>ignoreSubmodules</code> default is false, set to false, if you don't want to update a projects' submodule on deploy.</li>
<li><code>gitOptions</code> a keyed list of options to apply to a git command. Currently only pull is supported. If your git-version does not support <code>--rebase</code> you can disable it via an empty array: <code>pull: []</code></li>
</ul>
<h4 id="configuration-for-the-composer-method">Configuration for the composer-method</h4>
<ul>
<li><code>composerRootFolder</code> the folder where the composer.json for the project is stored, defaults to <code>gitRootFolder</code>.</li>
</ul>
<h4 id="configuration-for-the-crush-method">Configuration for the crush-method</h4>
<ul>
<li><code>siteFolder</code> is a drupal-specific folder, where the settings.php resides for the given installation. This allows to interact with multisites etc.</li>
<li><code>filesFolder</code> the path to the files-folder, where user-assets get stored and which should be backed up by the <code>files</code>-method</li>
<li><code>revertFeatures</code>, defaults to <code>True</code>, when set all features will be reverted when running a reset (drush only)</li>
<li><code>configurationManagement</code>, an array of configuration-labels to import on <code>reset</code>, defaults to <code>['staging']</code>. You can add command arguments for drush, e.g. <code>['staging', 'dev --partial']</code></li>
<li><code>database</code> the database-credentials the <code>install</code>-tasks uses when installing a new installation.<ul>
<li><code>name</code> the database name</li>
<li><code>host</code> the database host</li>
<li><code>user</code> the database user</li>
<li><code>pass</code> the password for the database user</li>
<li><code>prefix</code> the optional table-prefix to use</li>
</ul>
</li>
<li><code>adminUser</code>, default is <code>admin</code>, the name of the admin-user to set when running the reset-task on <code>dev</code>-instances</li>
<li><code>replaceSettingsFile</code>, default is true. If set to false, the settings.php file will not be replaced when running an install.</li>
<li><code>installOptions</code> default is <code>distribution: minimal, locale: en, options: ''</code>. You can change the distribution to install and/ or the locale.  </li>
<li><code>drupalVersion</code> set the drupal-version to use. If not set phabalicious is trying to guess it from the <code>needs</code>-configuration.</li>
<li><code>drushVersion</code> set the used crush-version, default is <code>8</code>. Drush is not 100% backwards-compatible, for phabalicious needs to know its version.</li>
<li><code>supportsZippedBackups</code> default is true, set to false, when zipped backups are not supported</li>
</ul>
<h4 id="configuration-of-the-docker-method">Configuration of the docker-method</h4>
<ul>
<li><code>docker</code> for all docker-relevant configuration. <code>configuration</code> and <code>name</code>/<code>service</code> are the only required keys, all other are optional and used by the docker-tasks.<ul>
<li><code>configuration</code> should contain the key of the dockerHost-configuration in <code>dockerHosts</code></li>
<li><code>name</code> contains the name of the docker-container. This is needed to get the IP-address of the particular docker-container when using ssh-tunnels (see above).</li>
<li>for docker-compose-base setups you can provide the <code>service</code> instead the name, phabalicious will get the docker name automatically from the service.</li>
</ul>
</li>
</ul>
<h3 id="dockerhosts">dockerHosts</h3>
<p><code>dockerHosts</code> is similar structured as the <code>hosts</code>-entry. It's a keyed lists of hosts containing all necessary information to create a ssh-connection to the host, controlling the docker-instances, and a list of tasks, the user might call via the <code>docker</code>-command. See the <code>docker</code>-entry for a more birds-eye-view of the concepts.</p>
<p>Here's an example <code>dockerHosts</code>-entry:</p>
<pre><code class="yaml">dockerHosts:
  mbb:
    runLocally: false
    host: multibasebox.dev
    user: vagrant
    password: vagrant
    port: 22
    rootFolder: /vagrant
    environment:
      VHOST: %host.host%
      WEBROOT: %host.rootFolder%
    tasks:
      logs:
        - docker logs %host.docker.name%
</code></pre>

<p>Here's a list of all possible entries of a dockerHosts-entry:
<em> <code>shellProvider</code>, the shell-provider to use, currently <code>local</code> or <code>ssh</code>.
</em> <code>runLocally</code>: if set to true, the <code>local</code>-shell-provider will be used.
<em> <code>host</code>, <code>user</code> and <code>port</code>: when using the <code>ssh</code>-shell-provicer. 
</em> <code>environment</code> a keyed list of environment-variables to set, when running one of the tasks. The replacement-patterns of <code>scripts</code> are supported, see there for more information.
* <code>tasks</code> a keyed list of commands to run for a given docker-subtask (similar to <code>scripts</code>). Note: these commands are running on the docker-host, not on the host. All replacement-patterns do work, and you can call even other tasks via <code>execute(&lt;task&gt;, &lt;subtask&gt;)</code> e.g. <code>execute(docker, stop)</code> See the <code>scripts</code>-section for more info.</p>
<p>You can use <code>inheritsFrom</code> to base your configuration on an existing one. You can add any configuration you may need and reference to that information from within your tasks via the replacement-pattern <code>%dockerHost.keyName%</code> e.g. <code>%dockerHost.host%</code>.</p>
<p>You can reference a specific docker-host-configuration from your host-configuration via</p>
<pre><code class="yaml">hosts:
  test:
    docker:
      configuration: mbb
</code></pre>

<h3 id="common">common</h3>
<p>common contains a list of commands, keyed by task and type which gets executed when the task is executed.</p>
<p>Example:</p>
<pre><code class="yaml">common:
  reset:
    dev:
      - echo &quot;running reset on a dev-instance&quot;
    stage:
      - echo &quot;running reset on a stage-instance&quot;
    prod:
      - echo &quot;running reset on a prod-instance&quot;
  deployPrepare:
    dev:
      - echo &quot;preparing deploy on a dev instance&quot;
  deploy:
    dev:
      - echo &quot;deploying on a dev instance&quot;
  deployFinished:
    dev:
      - echo &quot;finished deployment on a dev instance&quot;
</code></pre>

<p>The first key is the task-name (<code>reset</code>, <code>deploy</code>, ...), the second key is the type of the installation (<code>dev</code>, <code>stage</code>, <code>prod</code>, <code>test</code>). Every task is prepended by a prepare-stage and appended by a finished-stage, so you can call scripts before and after an actual task. You can even run other scripts via the <code>execute</code>-command, see the <code>scripts</code>-section.</p>
<h3 id="scripts">scripts</h3>
<p>A keyed list of available scripts. This scripts may be defined globally (on the root level) or on a per host-level. The key is the name of the script and can be executed via</p>
<pre><code class="shell">phab --config=&lt;configuration&gt; script &lt;key&gt;
</code></pre>

<p>A script consists of an array of commands which gets executed sequentially.</p>
<p>An example:</p>
<pre><code class="yaml">scripts:
  test:
    - echo &quot;Running script test&quot;
  test2:
    - echo &quot;Running script test2 on %host.config_name%
    - execute(script, test)
</code></pre>

<p>Scripts can be defined on a global level, but also on a per host-level.</p>
<p>You can declare default-values for arguments via a slightly modified syntax:</p>
<pre><code class="yaml">scripts:
  defaultArgumentTest:
    defaults:
      name: Bob
    script:
      - echo &quot;Hello %arguments.name%&quot;
</code></pre>

<p>Running the script via <code>phab config:mbb script:defaultArgumentTest,name="Julia"</code> will show <code>Hello Julia</code>. Running <code>phab config:mbb script:defaultArgumentTest</code> will show <code>Hello Bob</code>.</p>
<p>For more information see the main scripts section below.</p>
<h3 id="other">other</h3>
<ul>
<li><code>deploymentModule</code> name of the deployment-module the drush-method enables when doing a deploy</li>
<li><code>sqlSkipTables</code> a list of table-names drush should omit when doing a backup.</li>
<li><code>configurationManagement</code> a list of configuration-labels to import on <code>reset</code>. This defaults to <code>['staging']</code> and may be overridden on a per-host basis. You can add command arguments to the the configuration label.</li>
</ul>
<p>Example:</p>
<pre><code class="yaml">deploymentModule: my_deployment_module
usePty: false
useShell: false
gitOptions:
  pull:
    - --rebase
    - --quiet
sqlSkipTables:
  - cache
  - watchdog
  - session
configurationManagement:
   staging:
     - drush config-import -y staging
   dev:
       - Drusch config-import -y dev --partial
</code></pre>

<h2 id="inheritance">Inheritance</h2>
<p>Sometimes it make sense to extend an existing configuration or to include configuration from other places from the file-system or from remote locations. There's a special key <code>inheritsFrom</code> which will include the yaml found at the location and merge it with the data. This is supported for entries in <code>hosts</code> and <code>dockerHosts</code> and for the fabfile itself.</p>
<p>If a <code>host</code>, a <code>dockerHost</code> or the fabfile itself has the key <code>inheritsFrom</code>, then the given key is used as a base-configuration. Here's a simple example:</p>
<pre><code class="yaml">hosts:
  default:
    port: 22
    host: localhost
    user: default
  example1:
    inheritsFrom: default
    port: 23
  example2:
    inheritsFrom: example1
    user: example2
</code></pre>

<p><code>example1</code> will store the merged configuration from <code>default</code> with the configuration of <code>example1</code>. <code>example2</code> is a merge of all three configurations: <code>example2</code> with <code>example1</code> with <code>default</code>.</p>
<pre><code class="yaml">hosts:
  example1:
    port: 23
    host: localhost
    user: default
  example2:
    port: 23
    host: localhost
    user: example2
</code></pre>

<p>You can even reference external files to inherit from:</p>
<pre><code class="yaml">hosts:
  fileExample:
    inheritsFrom: ./path/to/config/file.yaml
  httpExapme:
    inheritsFrom: http://my.tld/path/to/config_file.yaml
</code></pre>

<p>This mechanism works also for the fabfile.yaml / index.yaml itself, and is not limited to one entry:</p>
<pre><code class="yaml">name: test fabfile

inheritsFrom:
  - ./mbb.yaml
  - ./drupal.yaml
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../docker-integration/" class="btn btn-neutral float-right" title="Docker integration">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../available-tasks/" class="btn btn-neutral" title="Available tasks"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>© 2018 Factorial GmbH, Hamburg</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/factorial-io/phabalicious/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../available-tasks/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../docker-integration/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../js/version-select.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
