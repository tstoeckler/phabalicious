<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Factorial GmbH, Hamburg">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Scripts - Phabalicious</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/version-select.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Scripts";
    var mkdocs_page_input_path = "scripts.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Phabalicious</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">How does phabalicious work in two sentences</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../installation/">Installation of needed dependencies</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../usage/">Running phabalicious</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../available-tasks/">Available tasks</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../configuration/">Structure of the configuration file</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docker-integration/">Docker integration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../local-overrides/">Local overrides</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Scripts</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#scripts">Scripts</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#replacement-patterns">Replacement-patterns</a></li>
        
            <li><a class="toctree-l3" href="#internal-commands">Internal commands</a></li>
        
            <li><a class="toctree-l3" href="#task-related-scripts">Task-related scripts</a></li>
        
            <li><a class="toctree-l3" href="#examples">Examples</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../app-scaffold/">Scaffolding a new app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../app-create-destroy/">Creating/ destroying an app from existing configuration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../passwords/">Passwords</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../contribute/">Contributing to Phabalicious</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Changelog/">Changelog</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Phabalicious</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Scripts</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/factorial-io/phabalicious/edit/develop/docs/docs/scripts.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="scripts">Scripts</h1>
<p>Scripts are a powerful concept of phabalicious. There are a lot of places where scripts can be called. The <code>common</code>-section defines common scripts to be run for specific task/installation-type-configurations, docker-tasks are also scripts which you can execute via the docker-command. And you can even script phabalicious tasks and create meta-tasks. And you can add custom scripts to the general section of a fabfile or to a host-configuration. Scripts can call other scripts.</p>
<p>A script is basically a list of commands which get executed via shell on a local or remote machine. To stay independent of the host where the script is executed, phabalicious parses the script before executing it and replaces given variables with their counterpart in the yaml file.</p>
<h2 id="replacement-patterns">Replacement-patterns</h2>
<p>Replacement-Patterns are specific strings enclosed in <code>%</code>s, e.g. <code>%host.port%</code>, <code>%dockerHost.rootFolder%</code> or <code>%arguments.name%</code>.</p>
<p>Here's a simple example;</p>
<pre><code class="yaml">script:
  test:
    - echo &quot;I am running on %host.config_name%&quot;
</code></pre>

<p>Calling this script via</p>
<pre><code class="shell">phab config:mbb script:test
</code></pre>

<p>will show <code>I am running on mbb</code>.</p>
<ul>
<li>The host-configuration gets exposes via the <code>host.</code>-prefix, so <code>port</code> maps to <code>%host.port%</code>, etc.</li>
<li>The dockerHost-configuration gets exposed via the <code>dockerHost</code>-prefix, so <code>rootFolder</code> maps to <code>%dockerHost.rootFolder%</code></li>
<li>The global configuration of the yams-file gets exposed to the <code>settings</code>-prefix, so <code>uuid</code> gets mapped to `%settings.uuid%</li>
<li>Optional arguments to the <code>script</code>-taks get the <code>argument</code>-prefix, e.g. <code>%arguments.name%</code>. You can get all arguments via <code>%arguments.combined%</code>.</li>
<li>You can access hierarchical information via the dot-operator, e.g. <code>%host.database.name%</code></li>
</ul>
<p>If phabalicious detects a pattern it can't replace it will abort the execution of the script and displays a list of available replacement-patterns.</p>
<h2 id="internal-commands">Internal commands</h2>
<p>There are currently 3 internal commands. These commands control the flow inside phabalicious:</p>
<ul>
<li><code>fail_on_error(1|0)</code> If fail_on_error is set to one, phabalicious will exit if one of the script commands returns a non-zero return-code. When using <code>fail_on_error(0)</code> only a warning is displayed, the script will continue.</li>
<li><code>execute(task, subtask, arguments)</code> execute a phabalicious task. For example you can run a deployment from a script via <code>execute(deploy)</code> or stop a docker-container from a script via <code>execute(docker, stop)</code></li>
<li><code>fail_on_missing_directory(directory, message)</code> will print message <code>message</code> if the directory <code>directory</code> does not exist.</li>
</ul>
<h2 id="task-related-scripts">Task-related scripts</h2>
<p>You can add scripts to the <code>common</code>-section, which will called for any host. You can differentiate by task-name and host-type, e.g. create a script which gets called for the task <code>deploy</code> and type <code>dev</code>.</p>
<p>You can even run scripts before or after a task is executed. Append the task with <code>Prepare</code> or <code>Finished</code>.</p>
<p>You can even run scripts for specific tasks and hosts. Just add your script with the task-name as its key.</p>
<pre><code class="yaml">host:
  test:
    deployPrepare:
      - echo &quot;Preparing deploy for test&quot;
    deploy:
      - echo &quot;Deploying on test&quot;
    deployFinished:
      - echo &quot;Deployment finished for test&quot;
</code></pre>

<p>These scripts in the above examples gets executed only for the host <code>test</code> and task <code>deploy</code>.</p>
<h2 id="examples">Examples</h2>
<p>A rather complex example scripting phabalicious.</p>
<pre><code class="yaml">scripts:
  runTests:
    defaults:
      branch: develop
    script:
      - execute(docker, start)
      - execute(docker, waitForServices)
      - execute(deploy, %arguments.branch%)
      - execute(script, behatInstall)
      - execute(script, behat, --profile=ci --format=junit --format=progress)
      - execute(getFile, /var/www/_tools/behat/build/behat/default.xml, ./_tools/behat)
      - execute(docker, stop)
</code></pre>

<p>This script will</p>
<ul>
<li>start the docker-container,</li>
<li>wait for it,</li>
<li>deploys the given branch,</li>
<li>run a script which will install behat,</li>
<li>run behat with some custom arguments,</li>
<li>gets the result-file and copy it to a location,</li>
<li>and finally stops the container.</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../app-scaffold/" class="btn btn-neutral float-right" title="Scaffolding a new app">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../local-overrides/" class="btn btn-neutral" title="Local overrides"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>© 2018 Factorial GmbH, Hamburg</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/factorial-io/phabalicious/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../local-overrides/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../app-scaffold/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../js/version-select.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
